<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simulation Centre d'Appel - Immersive Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
            max-width: 100vw; /* S√©curit√© mobile */
        }
        
        .digit-font {
            font-family: 'Roboto Mono', monospace;
            font-variant-numeric: tabular-nums;
        }

        @keyframes urgent-pulse {
            0% { background-color: rgba(220, 38, 38, 0.2); transform: scale(1); }
            50% { background-color: rgba(220, 38, 38, 0.6); transform: scale(1.05); }
            100% { background-color: rgba(220, 38, 38, 0.2); transform: scale(1); }
        }

        .metric-critical {
            animation: urgent-pulse 1s infinite ease-in-out;
            border-color: #ef4444 !important;
            color: #fca5a5 !important;
        }

        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* BANDEAU D√âFILANT (TICKER) */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            height: 3.5rem;
            background-color: rgba(0, 0, 0, 0.95);
            border-top: 1px solid #4b5563; 
            z-index: 50; 
            display: flex;
            align-items: center;
            flex-shrink: 0; 
            position: relative; /* CRUCIAL pour contenir l'enfant absolute */
        }

        .ticker-message-container {
            position: absolute;
            white-space: nowrap;
            will-change: transform;
            left: 0; /* Point de d√©part relatif au parent */
        }

        @keyframes scroll-message {
            from { transform: translateX(100%); } /* Utiliser % du parent, pas vw */
            to { transform: translateX(-100%); } /* Sortir compl√®tement √† gauche */
        }

        /* NOTIFICATIONS FLASH */
        #flash-container {
            position: fixed;
            top: 6rem;
            right: 1rem;
            width: 90%; /* Adapt√© mobile */
            max-width: 28rem;
            z-index: 60;
            pointer-events: none; 
        }
        
        .flash-toast {
            background: rgba(31, 41, 55, 0.95);
            border-left: 6px solid #3b82f6; 
            padding: 1.5rem; 
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px);
        }
        
        .flash-toast.show {
            transform: translateX(0);
        }

        .recording-badge {
            animation: blink-record 2s infinite;
        }
        
        @keyframes blink-record {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* GESTION DU MENU RETRACTABLE AVEC TRANSITION */
        #controlPanel {
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, padding 0.5s ease;
            max-height: 300px; /* Augment√© pour mobile */
            opacity: 1;
            overflow: hidden;
        }

        #controlPanel.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-[100dvh] flex flex-col justify-between transition-colors duration-1000 relative" id="appBody">

    <!-- En-t√™te -->
    <header class="bg-gray-800/80 p-3 flex justify-between items-center border-b border-gray-700 h-[8vh] z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i class="fa-solid fa-tower-broadcast text-xl text-white"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold uppercase tracking-wider text-gray-200 hidden md:block">Centre de Contr√¥le</h1>
                <h1 class="text-lg font-bold uppercase tracking-wider text-gray-200 md:hidden">Simu-Appel</h1>
                <p class="text-[10px] text-gray-400">STATUS: <span id="systemStatus" class="text-green-400 font-bold">ACTIF</span></p>
            </div>
        </div>
        
        <!-- Indicateur √âcoute Qualit√© -->
        <div id="monitoringBadge" class="hidden flex items-center gap-2 bg-red-900/80 border border-red-500 px-4 py-2 rounded text-red-100 font-bold text-sm recording-badge uppercase tracking-wider shadow-[0_0_15px_rgba(239,68,68,0.5)] absolute left-1/2 transform -translate-x-1/2 top-16 md:static md:transform-none md:top-auto z-50">
            <i class="fa-solid fa-headset text-lg"></i> <span class="hidden md:inline">√âcoute Qualit√© en cours</span><span class="md:hidden">√âCOUTE</span>
        </div>

        <div class="text-right flex items-center gap-4">
            <button id="btnMute" onclick="toggleMute()" class="text-gray-400 hover:text-white border border-gray-600 rounded px-2 py-1 text-xs">
                <i class="fa-solid fa-volume-high"></i> SON ON
            </button>
            <div>
                <span class="block text-xs text-gray-400 uppercase">Heure</span>
                <span id="realClock" class="text-xl font-mono text-white font-bold">00:00</span>
            </div>
        </div>
    </header>

    <!-- Zone Notifications Flash -->
    <div id="flash-container"></div>

    <!-- Zone Principale -->
    <main class="flex-grow flex flex-col p-4 gap-4 relative z-10 overflow-hidden" id="mainContainer">
        
        <!-- SECTION 1: M√©triques -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 h-[auto] md:h-[25vh] shrink-0">
            <!-- En Attente -->
            <div id="cardQueue" class="glass-panel rounded-2xl flex flex-col items-center justify-center relative overflow-hidden shadow-xl border-t-4 border-transparent p-4">
                <h2 class="text-gray-400 uppercase text-xs md:text-lg font-bold tracking-widest mb-1">En Attente</h2>
                <div class="text-5xl md:text-8xl font-black digit-font text-white z-10" id="queueVal">0</div>
                <i class="fa-solid fa-users absolute -bottom-4 -right-4 text-6xl md:text-9xl text-white/5 z-0"></i>
                <div id="queueWarning" class="hidden absolute inset-0 border-4 border-red-500 animate-pulse rounded-2xl pointer-events-none"></div>
            </div>

            <!-- Niveau de Service -->
            <div id="cardSLA" class="glass-panel rounded-2xl flex flex-col items-center justify-center border-t-4 border-green-500/50 bg-gray-800/40 relative overflow-hidden p-4">
                <h2 class="text-gray-400 uppercase text-xs md:text-sm font-bold tracking-widest mb-1">Niveau Svc.</h2>
                <div class="text-4xl md:text-6xl font-bold digit-font text-green-400 z-10" id="slaVal">100%</div>
                <i class="fa-solid fa-chart-line absolute -bottom-2 -right-2 text-6xl md:text-8xl text-white/5 z-0"></i>
            </div>

            <!-- Agents Dispo -->
            <div class="glass-panel rounded-2xl flex flex-col items-center justify-center border-t-4 border-green-500/50 bg-gray-800/40 p-4">
                <h2 class="text-gray-400 uppercase text-xs md:text-sm font-bold tracking-widest mb-1">Agents Dispo.</h2>
                <div class="text-4xl md:text-6xl font-bold digit-font text-green-400" id="agentsFreeVal">3</div>
            </div>

            <!-- Agents En Ligne -->
            <div class="glass-panel rounded-2xl flex flex-col items-center justify-center border-t-4 border-blue-500/50 bg-gray-800/40 p-4">
                <h2 class="text-gray-400 uppercase text-xs md:text-sm font-bold tracking-widest mb-1">En Ligne</h2>
                <div class="text-4xl md:text-6xl font-bold digit-font text-blue-400" id="agentsBusyVal">9</div>
            </div>
        </div>

        <!-- SECTION 2: Timer Personnel -->
        <div class="flex-grow glass-panel rounded-2xl flex flex-col items-center justify-center relative border-2 border-white/5 transition-all duration-500 min-h-0" id="timerPanel">
            
            <div id="statusBadge" class="mb-4 px-4 py-1 rounded-full text-xs md:text-sm font-bold uppercase tracking-widest bg-gray-700 text-gray-300">
                En attente d'appel
            </div>

            <div id="timerDisplay" class="digit-font text-[18vw] md:text-[12vw] leading-none font-bold drop-shadow-2xl select-none text-white">
                00:00
            </div>

            <div class="mt-2 text-sm md:text-xl uppercase tracking-widest text-white/60 font-medium">
                Objectif DMT: <span id="targetDisplay">05:00</span>
            </div>

            <div id="alertOverlay" class="absolute inset-0 bg-red-600/0 pointer-events-none transition-colors duration-500 rounded-2xl"></div>
            <div id="alertMessage" class="absolute bottom-10 text-xl md:text-5xl font-black uppercase text-red-100 hidden animate-bounce drop-shadow-lg text-center px-4">
                D√âPASSEMENT CRITIQUE
            </div>
        </div>
    </main>

    <!-- Bouton pour r√©afficher le menu -->
    <button onclick="toggleControls()" id="showControlsBtn" class="fixed bottom-16 left-1/2 transform -translate-x-1/2 bg-gray-800 text-gray-400 px-6 py-2 rounded-t-xl hidden hover:text-white hover:bg-gray-700 z-50 shadow-lg border-t border-gray-600">
        <i class="fa-solid fa-chevron-up"></i> MENU
    </button>

    <!-- Panneau de Contr√¥le -->
    <footer class="bg-gray-800 border-t border-gray-700 p-4 shadow-2xl w-full shrink-0 z-40" id="controlPanel">
        <div class="container mx-auto flex flex-col md:flex-row flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-3 bg-gray-700/50 p-2 rounded-lg border border-gray-600">
                <label class="text-xs text-gray-300 uppercase font-bold">Objectif</label>
                <input type="number" id="inputMin" value="8" class="w-12 bg-gray-800 border border-gray-600 rounded text-center text-white focus:border-blue-500 outline-none">
                <span class="text-gray-400">:</span>
                <input type="number" id="inputSec" value="00" class="w-12 bg-gray-800 border border-gray-600 rounded text-center text-white focus:border-blue-500 outline-none">
                <button onclick="setTarget()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-xs uppercase font-bold transition">OK</button>
            </div>
            <div class="flex gap-2 w-full md:w-auto justify-center">
                <button onclick="startSimulation()" id="btnStart" class="bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded-xl font-bold text-lg shadow-lg flex items-center gap-2 transition transform active:scale-95 border-b-4 border-green-800 flex-grow md:flex-grow-0 justify-center">
                    <i class="fa-solid fa-phone"></i> <span class="md:hidden">R√âPONDRE</span><span class="hidden md:inline">PRENDRE L'APPEL</span>
                </button>
                <button onclick="stopSimulation()" id="btnStop" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-xl font-bold text-lg shadow-lg flex items-center gap-2 transition hidden border-b-4 border-gray-800 flex-grow md:flex-grow-0 justify-center">
                    <i class="fa-solid fa-phone-slash"></i> RACCROCHER
                </button>
                <button onclick="resetSimulation()" class="text-gray-400 hover:text-white px-4 py-2 rounded-lg font-bold border border-gray-600 hover:border-gray-400 transition">
                    RESET
                </button>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleFullScreen()" class="bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-lg transition" title="Plein √âcran">
                    <i class="fa-solid fa-expand"></i>
                </button>
                <button onclick="toggleControls()" class="bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-lg transition" title="Masquer">
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
            </div>
        </div>
    </footer>

    <!-- BANDEAU D√âFILANT -->
    <div class="ticker-wrap" id="tickerWrap">
        <!-- Messages inject√©s via JS -->
    </div>

    <script>
        // --- Variables Globales ---
        let timerInterval, simulationInterval, randomEventInterval;
        let tickerTimeout; 
        let elapsedSeconds = 0;
        let targetSeconds = 480;
        let isRunning = false;
        
        // Simulation Data
        const TOTAL_AGENTS = 12;
        let queueCount = 0;
        let agentsBusy = 8;
        let agentsFree = 4;
        let serviceLevel = 100;
        let currentTimerState = 'green';
        
        // Audio & Messages
        let audioContext = null;
        let isMuted = false;

        // --- DOM Elements ---
        const timerDisplay = document.getElementById('timerDisplay');
        const timerPanel = document.getElementById('timerPanel');
        const appBody = document.getElementById('appBody');
        const alertOverlay = document.getElementById('alertOverlay');
        const alertMsg = document.getElementById('alertMessage');
        const statusBadge = document.getElementById('statusBadge');
        const cardQueue = document.getElementById('cardQueue');
        const cardSLA = document.getElementById('cardSLA'); 
        const tickerWrap = document.getElementById('tickerWrap');
        const elQueue = document.getElementById('queueVal');
        const elSLA = document.getElementById('slaVal'); 
        const elFree = document.getElementById('agentsFreeVal');
        const elBusy = document.getElementById('agentsBusyVal');
        const flashContainer = document.getElementById('flash-container');
        const monitoringBadge = document.getElementById('monitoringBadge');

        // --- Initialisation ---
        window.onload = function() {
            updateRealClock();
            setInterval(updateRealClock, 1000);
            updateMetricsUI();
            setTarget();
            startTickerLoop();
        };

        // --- AUDIO ---
        function initAudio() {
            if (!audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
            }
            if (audioContext.state === 'suspended') audioContext.resume();
        }

        function playTone(freq, type, duration) {
            if (isMuted || !audioContext) return;
            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            osc.type = type; 
            osc.frequency.setValueAtTime(freq, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + duration);
        }

        function playQueuePing() { playTone(600, 'sine', 0.1); }
        function playWarningBeep() { playTone(300, 'square', 0.3); setTimeout(() => playTone(300, 'square', 0.3), 400); }
        function playAlarm() { playTone(800, 'sawtooth', 0.1); setTimeout(() => playTone(600, 'sawtooth', 0.1), 150); }
        function playNotificationSound() { playTone(500, 'sine', 0.1); setTimeout(() => playTone(800, 'sine', 0.2), 100); }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('btnMute');
            if(isMuted) {
                btn.innerHTML = '<i class="fa-solid fa-volume-xmark"></i> MUET';
                btn.classList.add('text-red-400', 'border-red-400');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> SON ON';
                btn.classList.remove('text-red-400', 'border-red-400');
            }
        }

        // --- BANDEAU INTELLIGENT (MESSAGES QU√âB√âCOIS SATIRIQUES) ---
        const genericMessages = [
            "Motivation : Un client heureux, c'est un client qui raccroche vite !",
            "Rappel : Le 'P√¢t√© Chinois' de la caf√©t√©ria est √† 50% de rabais (y'en reste pu gros)",
            "L√¢chez pas la patate la gang ! On vise le bonus 'pizza froide' √† No√´l !",
            "Note de service : Interdit de pleurer au bureau, allez aux toilettes SVP",
            "Concours : Une carte Tim de 5$ pour celui qui prend le plus d'appels (Tirage en 2027)",
            "On garde le sourire dans la voix, m√™me si le client vous engueule !",
            "Rappel : Les pauses pipi sont chronom√©tr√©es, soyez efficaces",
            "F√©licitations √† Kevin pour son 3e avertissement, on l√¢che pas !",
            "La direction vous aime (surtout quand vous √™tes connect√©s)",
            "Propret√© : Ramassez vos miettes de toast dans le clavier, c'est d√©gueulasse",
            "Formation 'G√©rer sa col√®re en silence' disponible sur l'intranet",
            "Rappel : Le code vestimentaire s'applique aussi aux bas bruns",
            "N'oubliez pas : Le client a toujours raison (m√™me quand y'est dans le champ)"
        ];

        const alertMessages = [
            { text: "‚ö†Ô∏è AWEILLE ! La file monte, on niaise pas avec la puck !", condition: () => queueCount > 3 },
            { text: "‚ö†Ô∏è SLA EN CHUTE LIBRE ! √áa va fesser dans le dash !", condition: () => serviceLevel < 70 },
            { text: "üö® D√âBORDEMENT TOTAL : L√ÇCHEZ VOS CAF√âS PIS R√âPONDEZ !", condition: () => queueCount > 6 },
            { text: "‚ö†Ô∏è √áa jase trop ! Concluez √ßa au plus sacrant !", condition: () => currentTimerState === 'red' },
            { text: "‚ö†Ô∏è Oubliez la m√©t√©o, parlez business ! (DMT en hausse)", condition: () => currentTimerState === 'yellow' },
            { text: "üö® C'est qui l'clown en 'Auxiliaire' ? Embarquez sur la ligne !", condition: () => queueCount > 4 },
            { text: "üö® PANIQUE G√âN√âRALE : Le boss s'en vient sur le plancher !", condition: () => queueCount > 8 },
            { text: "‚ö†Ô∏è Grouillez-vous ! Y'a du monde √† messe !", condition: () => queueCount > 5 }
        ];

        function startTickerLoop() {
            if(tickerTimeout) clearTimeout(tickerTimeout);
            tickerWrap.innerHTML = '';

            let msgText = "";
            let msgType = "normal";

            const activeAlerts = alertMessages.filter(m => m.condition());
            
            if (activeAlerts.length > 0) {
                const alert = activeAlerts[Math.floor(Math.random() * activeAlerts.length)];
                msgText = alert.text;
                msgType = "alert";
            } else {
                if (Math.random() < 0.6) {
                    msgText = genericMessages[Math.floor(Math.random() * genericMessages.length)];
                    msgText = `<i class="fa-solid fa-info-circle mx-2 opacity-50"></i> ${msgText}`;
                } else {
                    tickerTimeout = setTimeout(startTickerLoop, 3000 + Math.random() * 4000);
                    return;
                }
            }

            const el = document.createElement('div');
            el.className = "ticker-message-container text-xl font-bold uppercase tracking-wider px-4";
            
            if (msgType === "alert") {
                el.classList.add("text-red-500", "font-black");
                if(msgText.includes("‚ö†Ô∏è")) el.classList.add("text-yellow-400");
                if(msgText.includes("üö®")) el.classList.add("text-red-500");
            } else {
                el.classList.add("text-gray-300");
            }
            
            el.innerHTML = msgText;
            tickerWrap.appendChild(el);

            // Calculer la dur√©e en fonction de la largeur de l'√©cran parent
            const wrapWidth = tickerWrap.offsetWidth;
            const textWidth = el.offsetWidth;
            const totalDistance = wrapWidth + textWidth;
            const duration = totalDistance / 100; 

            el.style.animation = `scroll-message ${duration}s linear forwards`;

            el.addEventListener('animationend', () => {
                el.remove();
                const pause = 2000 + Math.random() * 6000;
                tickerTimeout = setTimeout(startTickerLoop, pause);
            });
        }

        // --- FLASH & MONITORING (TEXTES AJUST√âS) ---
        const flashMessages = [
            { text: "Le CRM rame encore... faites semblant que vous cherchez", type: "warning" },
            { text: "Promo 'Fibre' annul√©e (on a oubli√© de vous le dire)", type: "info" },
            { text: "Visite du VP : Cachez vos tasses pas propres", type: "info" },
            { text: "Rappel : Code 404 change encore (voir courriel ignor√©)", type: "warning" },
            { text: "Bravo Ginette ! Vente record d'un modem 56k !", type: "success" },
            { text: "Camion de poutine en bas (mais vous avez pas le temps)", type: "info" },
            { text: "SVP arr√™tez de voler les chaises roulantes des autres", type: "info" },
            { text: "Rappel : Le parking est plein (comme d'hab)", type: "warning" },
            { text: "Client myst√®re en ligne ! Soyez fins pour une fois", type: "warning" },
            { text: "Syst√®me de paie bugg√©... on verra √ßa lundi", type: "warning" },
            { text: "Objectif atteint √† 12% ! On l√¢che pas !", type: "success" },
            { text: "Temp√™te de neige : Vous restez jusqu'√† minuit", type: "info" }
        ];

        function showFlashMessage(msgObj) {
            const div = document.createElement('div');
            let borderColor = 'border-blue-500';
            let icon = 'fa-info-circle';
            let textColor = 'text-blue-400';

            if(msgObj.type === 'warning') {
                borderColor = 'border-yellow-500';
                icon = 'fa-triangle-exclamation';
                textColor = 'text-yellow-400';
            }
            if(msgObj.type === 'success') {
                borderColor = 'border-green-500';
                icon = 'fa-trophy';
                textColor = 'text-green-400';
            }

            div.className = `flash-toast text-base text-white ${borderColor}`;
            div.innerHTML = `
                <div class="flex items-start gap-3">
                    <i class="fa-solid ${icon} ${textColor} mt-1 text-2xl"></i>
                    <div>
                        <h4 class="font-bold uppercase text-sm text-gray-400 mb-1">Flash Info</h4>
                        <p class="font-bold text-lg leading-tight">${msgObj.text}</p>
                    </div>
                </div>
            `;

            flashContainer.appendChild(div);
            if(!isMuted) playNotificationSound();

            requestAnimationFrame(() => { div.classList.add('show'); });
            setTimeout(() => {
                div.classList.remove('show');
                setTimeout(() => div.remove(), 600);
            }, 6000); 
        }

        function toggleMonitoring() {
            const isActive = !monitoringBadge.classList.contains('hidden');
            if (!isActive) {
                if(Math.random() < 0.05) {
                    monitoringBadge.classList.remove('hidden');
                    const duration = 60000 + Math.random() * 60000;
                    setTimeout(() => monitoringBadge.classList.add('hidden'), duration);
                }
            }
        }

        function triggerRandomEvents() {
            if(Math.random() < 0.15) { 
                const msg = flashMessages[Math.floor(Math.random() * flashMessages.length)];
                showFlashMessage(msg);
            }
            toggleMonitoring();
        }

        // --- SIMULATION ---
        function startSimulation() {
            if (isRunning) return;
            initAudio();
            isRunning = true;
            document.getElementById('btnStart').classList.add('hidden');
            document.getElementById('btnStop').classList.remove('hidden');
            statusBadge.innerText = "En Communication";
            statusBadge.className = "mb-4 px-4 py-1 rounded-full text-sm font-bold uppercase tracking-widest bg-blue-600 text-white";

            timerInterval = setInterval(() => {
                elapsedSeconds++;
                updateTimerDisplay();
                checkTimeThresholds();
            }, 1000);

            simulationInterval = setInterval(simulateCallCenterLife, 1000);
            randomEventInterval = setInterval(triggerRandomEvents, 5000);
            checkTimeThresholds();
        }

        function stopSimulation() {
            isRunning = false;
            clearInterval(timerInterval);
            clearInterval(simulationInterval);
            clearInterval(randomEventInterval);
            
            document.getElementById('btnStart').classList.remove('hidden');
            document.getElementById('btnStop').classList.add('hidden');
            statusBadge.innerText = "Appel Termin√© - Wrap Up";
            statusBadge.className = "mb-4 px-4 py-1 rounded-full text-sm font-bold uppercase tracking-widest bg-gray-600 text-white";
            timerPanel.classList.remove('animate-pulse');
            monitoringBadge.classList.add('hidden'); 
        }

        function resetSimulation() {
            stopSimulation();
            elapsedSeconds = 0;
            queueCount = 0;
            agentsBusy = 8;
            agentsFree = 4;
            currentTimerState = 'green';
            updateTimerDisplay();
            resetVisuals();
            updateMetricsUI();
        }

        function simulateCallCenterLife() {
            let agentReleaseChance = 0.05;
            if (agentsBusy > 0 && Math.random() < agentReleaseChance) { 
                agentsBusy--;
                agentsFree++;
            }
            if (queueCount > 0 && agentsFree > 0) {
                queueCount--;
                agentsFree--;
                agentsBusy++;
            }

            let ratio = (targetSeconds > 0) ? elapsedSeconds / targetSeconds : 0;
            let newCallChance = 0.0;
            
            if (ratio < 0.6) {
                newCallChance = 0.02;
                if (agentsFree > 5) newCallChance = 0.10;
            } else if (ratio < 0.8) {
                newCallChance = 0.08;
            } else if (ratio < 1.0) {
                newCallChance = 0.15;
            } else {
                let overtime = ratio - 1.0; 
                newCallChance = 0.20 + (overtime * 0.05);
            }

            if (Math.random() < newCallChance) {
                let incoming = 1;
                if (ratio > 1.2 && Math.random() < 0.15) incoming = 2;
                
                for(let i=0; i<incoming; i++) {
                    if (agentsFree > 0) {
                        agentsFree--;
                        agentsBusy++;
                    } else {
                        queueCount++;
                        if(queueCount % 2 === 0) playQueuePing();
                    }
                }
            }
            updateMetricsUI();
        }

        function updateMetricsUI() {
            elQueue.innerText = queueCount;
            elFree.innerText = agentsFree;
            elBusy.innerText = agentsBusy;

            let calculatedSLA = 100 - (queueCount * 1.25);
            if (calculatedSLA < 0) calculatedSLA = 0;
            calculatedSLA = Math.round(calculatedSLA);
            serviceLevel = calculatedSLA;
            
            elSLA.innerText = calculatedSLA + "%";

            if (calculatedSLA >= 80) {
                elSLA.className = "text-6xl font-bold digit-font text-green-400 z-10";
                cardSLA.className = "glass-panel rounded-2xl flex flex-col items-center justify-center border-t-4 border-green-500/50 bg-gray-800/40 relative overflow-hidden p-4";
            } else if (calculatedSLA >= 60) {
                elSLA.className = "text-6xl font-bold digit-font text-yellow-400 z-10";
                cardSLA.className = "glass-panel rounded-2xl flex flex-col items-center justify-center border-t-4 border-yellow-500/50 bg-gray-800/40 relative overflow-hidden p-4";
            } else {
                elSLA.className = "text-6xl font-bold digit-font text-red-500 animate-pulse z-10";
                cardSLA.className = "glass-panel rounded-2xl flex flex-col items-center justify-center border-t-4 border-red-500/50 bg-gray-800/40 relative overflow-hidden p-4";
            }

            if (queueCount >= 6) {
                cardQueue.classList.add('metric-critical');
                document.getElementById('queueWarning').classList.remove('hidden');
            } else {
                cardQueue.classList.remove('metric-critical');
                document.getElementById('queueWarning').classList.add('hidden');
            }
        }

        function checkTimeThresholds() {
            const timeLeft = targetSeconds - elapsedSeconds;
            
            appBody.classList.remove('bg-gray-900', 'bg-green-900', 'bg-yellow-900', 'bg-red-900');
            timerPanel.classList.remove('border-green-500', 'border-yellow-500', 'border-red-500');
            alertOverlay.className = "absolute inset-0 bg-red-600/0 pointer-events-none transition-colors duration-500 rounded-2xl";

            if (elapsedSeconds >= targetSeconds) {
                if (currentTimerState !== 'red') {
                    playAlarm();
                    currentTimerState = 'red';
                }
                appBody.classList.add('bg-red-900');
                timerPanel.classList.add('border-red-500', 'bg-red-900/50');
                alertOverlay.classList.replace('bg-red-600/0', 'bg-red-600/20');
                statusBadge.innerText = "D√âPASSEMENT";
                statusBadge.className = "mb-4 px-4 py-1 rounded-full text-sm font-bold uppercase tracking-widest bg-red-600 text-white animate-pulse";
                alertMsg.classList.remove('hidden');
                timerDisplay.classList.add('text-red-200');
            } else if (timeLeft <= 90 && timeLeft > 0) {
                if (currentTimerState !== 'yellow') {
                    playWarningBeep();
                    currentTimerState = 'yellow';
                }
                appBody.classList.add('bg-yellow-900');
                timerPanel.classList.add('border-yellow-500', 'bg-yellow-900/30');
                statusBadge.innerText = "Attention - Wrap Up";
                statusBadge.className = "mb-4 px-4 py-1 rounded-full text-sm font-bold uppercase tracking-widest bg-yellow-500 text-black";
                alertMsg.classList.add('hidden');
                timerDisplay.classList.remove('text-red-200');
            } else {
                currentTimerState = 'green';
                appBody.classList.add('bg-gray-900');
                timerPanel.classList.add('border-green-500/30');
                alertMsg.classList.add('hidden');
                timerDisplay.classList.remove('text-red-200');
            }
        }

        function setTarget() {
            const min = parseInt(document.getElementById('inputMin').value) || 0;
            const sec = parseInt(document.getElementById('inputSec').value) || 0;
            targetSeconds = (min * 60) + sec;
            document.getElementById('targetDisplay').innerText = 
                `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            if(elapsedSeconds > 0) checkTimeThresholds();
        }

        function updateTimerDisplay() {
            const min = Math.floor(elapsedSeconds / 60);
            const sec = elapsedSeconds % 60;
            timerDisplay.innerText = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }

        function resetVisuals() {
            appBody.className = "bg-gray-900 text-white h-[100dvh] flex flex-col justify-between transition-colors duration-1000 relative";
            timerPanel.className = "flex-grow glass-panel rounded-2xl flex flex-col items-center justify-center relative border-2 border-white/5 transition-all duration-500 min-h-0";
            statusBadge.innerText = "Pr√™t";
            statusBadge.className = "mb-4 px-4 py-1 rounded-full text-sm font-bold uppercase tracking-widest bg-gray-700 text-gray-300";
            alertMsg.classList.add('hidden');
            timerDisplay.classList.remove('text-red-200');
            cardQueue.classList.remove('metric-critical');
            document.getElementById('queueWarning').classList.add('hidden');
            monitoringBadge.classList.add('hidden');
        }

        function updateRealClock() {
            const now = new Date();
            document.getElementById('realClock').innerText = 
                now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        function toggleControls() {
            const footer = document.getElementById('controlPanel');
            const showBtn = document.getElementById('showControlsBtn');
            
            if (footer.classList.contains('collapsed')) {
                // MONTRER
                footer.classList.remove('collapsed');
                showBtn.classList.add('hidden');
            } else {
                // CACHER
                footer.classList.add('collapsed');
                showBtn.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
